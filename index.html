<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Road Angel">
    <meta name="theme-color" content="#0f172a">
    <meta name="description" content="Road Angel Response â€” one tap to alert dispatch">
    <link rel="manifest" href="manifest.json">
    <!-- iOS home screen icon â€” inline so no missing file error -->
    <link rel="apple-touch-icon" href="icon.png">
    <title>Road Angel - Emergency Response</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        html, body {
            height: 100%; height: 100dvh;
            overscroll-behavior: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            background: #0a1628;
            color: #fff;
            overflow: hidden;
            /* Safe areas for notch / home bar */
            padding-top:    env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            padding-left:   env(safe-area-inset-left);
            padding-right:  env(safe-area-inset-right);
        }

        .app {
            width: 100%; max-width: 480px; margin: 0 auto;
            height: 100dvh; display: flex; flex-direction: column;
            padding: 0;
            /* Offset safe-area already applied to body */
        }

        /* â”€â”€ Notification toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .notification {
            position: fixed; top: max(16px, env(safe-area-inset-top));
            left: 50%; transform: translateX(-50%);
            z-index: 200; padding: 13px 22px; border-radius: 14px;
            font-weight: 700; font-size: 14px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
            animation: slideDown 0.3s ease-out;
            display: none; text-align: center;
            width: calc(100% - 32px); max-width: 340px;
        }
        .notification.show    { display: block; }
        .notification.success { background: #16a34a; }
        .notification.error   { background: #dc2626; }
        .notification.warning { background: #ea580c; }
        .notification.info    { background: #2563eb; }
        @keyframes slideDown {
            from { opacity:0; transform: translateX(-50%) translateY(-16px); }
            to   { opacity:1; transform: translateX(-50%) translateY(0); }
        }

        /* â”€â”€ Pages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .page {
            display: none; flex: 1; flex-direction: column;
            overflow-y: auto; overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }
        .page.active { display: flex; }

        /* â”€â”€ Landing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .landing-content {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            text-align: center; padding: 32px 28px;
        }
        .logo-container {
            width: 88px; height: 88px;
            background: linear-gradient(135deg, #f97316, #dc2626);
            border-radius: 22px; display: flex; align-items: center; justify-content: center;
            margin-bottom: 20px;
            box-shadow: 0 16px 32px rgba(249,115,22,0.35);
            animation: pulse-anim 3s ease-in-out infinite;
            font-size: 44px;
        }
        @keyframes pulse-anim { 0%,100%{transform:scale(1);} 50%{transform:scale(1.05);} }
        .app-title {
            font-size: clamp(36px, 10vw, 52px);
            font-weight: 900; letter-spacing: -2px; margin-bottom: 10px;
            background: linear-gradient(to right, #fff, #f97316);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .app-subtitle { color: #94a3b8; margin-bottom: 14px; font-size: 15px; line-height: 1.5; max-width: 260px; }
        .app-tags { display: flex; gap: 8px; justify-content: center; margin-bottom: 40px; flex-wrap: wrap; }
        .tag { padding: 5px 11px; background: #1e293b; border-radius: 20px; font-size: 11px; color: #64748b; }
        .button-group { width: 100%; display: flex; flex-direction: column; gap: 12px; }
        .btn {
            padding: 17px; border: none; border-radius: 16px; font-weight: 700;
            cursor: pointer; transition: all 0.2s; font-size: 16px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            min-height: 54px; /* iOS tap target */
        }
        .btn-primary {
            background: linear-gradient(135deg, #ea580c, #dc2626);
            color: white; box-shadow: 0 8px 24px rgba(234,88,12,0.35);
        }
        .btn-primary:active { transform: scale(0.97); }
        .btn-secondary { background: #1e293b; color: #cbd5e1; border: 1px solid #334155; }
        .btn-secondary:active { background: #0f172a; }

        /* â”€â”€ Forms â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .form-container {
            flex: 1; display: flex; flex-direction: column;
            overflow-y: auto; -webkit-overflow-scrolling: touch;
            padding: 20px 24px 32px;
        }
        .form-header {
            display: flex; align-items: center; gap: 8px;
            margin-bottom: 20px; color: #94a3b8; cursor: pointer;
            font-size: 15px; min-height: 44px;
        }
        .form-header:active { color: #e2e8f0; }
        .form-title    { font-size: 26px; font-weight: 900; margin-bottom: 6px; }
        .form-subtitle { color: #94a3b8; font-size: 14px; margin-bottom: 24px; line-height: 1.5; }
        .form { display: flex; flex-direction: column; gap: 14px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        .input-wrapper {
            background: #1a2540; border: 1.5px solid #2d3f5c;
            border-radius: 14px; padding: 14px;
            display: flex; flex-direction: column; transition: border-color 0.2s;
        }
        .input-wrapper:focus-within { border-color: #f97316; }
        .input-label { font-size: 10px; color: #64748b; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; margin-bottom: 6px; }
        /* 16px prevents iOS auto-zoom on focus */
        .input-wrapper input { background: transparent; border: none; outline: none; color: #fff; font-size: 16px; }
        .input-wrapper input::placeholder { color: #475569; }

        .phone-prefix {
            display: flex; align-items: center; gap: 8px;
        }
        .phone-prefix-label {
            font-size: 16px; color: #f97316; font-weight: 700; white-space: nowrap;
        }
        .phone-prefix input { flex: 1; }

        .section-divider {
            padding: 10px 0 2px; font-size: 10px; font-weight: 700;
            color: #64748b; text-transform: uppercase; text-align: center;
            border-top: 1px solid #1e293b; margin: 4px 0; letter-spacing: 1px;
        }

        /* â”€â”€ Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .dash-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 20px 12px;
            background: linear-gradient(180deg, #0f172a 0%, transparent 100%);
        }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .user-avatar {
            width: 44px; height: 44px; flex-shrink: 0;
            background: linear-gradient(135deg, #ea580c, #dc2626);
            border-radius: 12px; display: flex; align-items: center; justify-content: center;
            font-weight: 900; font-size: 16px; border: 2px solid rgba(249,115,22,0.3);
        }
        .user-name { font-size: 15px; font-weight: 700; line-height: 1.2; }
        .user-sub  { font-size: 11px; color: #64748b; margin-top: 1px; }
        .icon-btns { display: flex; gap: 6px; }
        .icon-btn {
            width: 44px; height: 44px; background: #1a2540;
            border: 1.5px solid #2d3f5c; border-radius: 12px; color: #94a3b8;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 17px; transition: all 0.2s;
        }
        .icon-btn:active { background: #0f172a; transform: scale(0.93); }
        .icon-btn.logout:active { border-color: #dc2626; }

        /* Status pills row */
        .status-pills {
            display: flex; gap: 8px; padding: 0 20px 10px; flex-wrap: wrap;
        }
        .status-pill {
            display: flex; align-items: center; gap: 6px;
            padding: 7px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;
            flex: 1; min-width: 120px;
        }
        .pill-firebase {
            background: rgba(59,130,246,0.12); border: 1px solid rgba(59,130,246,0.25);
            color: #93c5fd;
        }
        .pill-gps {
            background: rgba(34,197,94,0.12); border: 1px solid rgba(34,197,94,0.25);
            color: #86efac;
        }
        .pill-gps.error {
            background: rgba(220,38,38,0.12); border-color: rgba(220,38,38,0.25); color: #fca5a5;
        }
        .pill-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
        .pill-dot.blue  { background: #3b82f6; animation: pulse-anim 1.5s infinite; }
        .pill-dot.green { background: #22c55e; animation: pulse-anim 1.5s infinite; }
        .pill-dot.red   { background: #ef4444; animation: none; }
        .pill-dot.grey  { background: #64748b; animation: none; }

        /* Old banners â€” hidden on mobile (replaced by pills) */
        .firebase-status, .banner { display: none !important; }

        /* GPS error shown as pill with retry */
        .gps-err-pill {
            display: none; align-items: center; gap: 8px;
            background: rgba(220,38,38,0.12); border: 1px solid rgba(220,38,38,0.3);
            border-radius: 14px; padding: 10px 14px; margin: 0 20px 10px; font-size: 12px; color: #fca5a5;
        }
        .gps-err-pill.show { display: flex; }
        .retry-btn {
            background: #dc2626; color: white; padding: 5px 12px;
            border-radius: 8px; border: none; font-weight: 700; cursor: pointer;
            font-size: 11px; margin-left: auto; min-height: 32px;
        }

        /* â”€â”€ Panic button area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .panic-wrap {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            padding: 16px 20px;
            gap: 0;
        }
        .panic-ring {
            position: relative; display: flex; align-items: center; justify-content: center;
            margin-bottom: 20px;
        }
        .panic-btn {
            width: min(72vw, 260px); height: min(72vw, 260px);
            border-radius: 50%;
            background: radial-gradient(circle at 35% 30%, #ef4444 0%, #b91c1c 60%, #7f1d1d 100%);
            border: none; outline: none;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; position: relative;
            box-shadow:
                0 0 0 12px rgba(220,38,38,0.08),
                0 0 0 24px rgba(220,38,38,0.05),
                0 24px 60px rgba(220,38,38,0.55);
            transition: transform 0.15s, box-shadow 0.15s;
            font-weight: 900; color: white;
            -webkit-user-select: none; user-select: none;
        }
        .panic-btn::after {
            content: ''; position: absolute; inset: 0; border-radius: 50%;
            border: 3px solid rgba(255,255,255,0.15);
        }
        .panic-btn::before {
            content: ''; position: absolute;
            width: 100%; height: 100%; border-radius: 50%;
            border: 2px solid rgba(220,38,38,0.6);
            animation: ring 2s cubic-bezier(0,0,0.2,1) infinite;
        }
        @keyframes ring { 0%{transform:scale(1);opacity:0.7} 100%{transform:scale(1.6);opacity:0;} }
        .panic-btn:not(:disabled):active { transform: scale(0.94); box-shadow: 0 8px 30px rgba(220,38,38,0.6); }
        .panic-btn:disabled { opacity: 0.35; cursor: not-allowed; }
        .panic-btn:disabled::before { animation: none; }
        .panic-icon  { font-size: 52px; margin-bottom: 6px; z-index: 1; line-height: 1; }
        .panic-label { font-size: 26px; letter-spacing: 2px; z-index: 1; }
        .panic-sub   { font-size: 9px; opacity: 0.65; margin-top: 5px; z-index: 1; letter-spacing: 1px; }
        .sys-status  { font-size: 11px; color: #475569; letter-spacing: 0.5px; text-align: center; }

        /* Info cards strip */
        .info-cards {
            display: flex; gap: 8px;
            padding: 0 20px 20px;
        }
        .info-card {
            flex: 1; background: #1a2540; padding: 12px 8px;
            border-radius: 14px; border: 1.5px solid #2d3f5c;
            display: flex; flex-direction: column; align-items: center; text-align: center;
        }
        .card-icon   { font-size: 16px; margin-bottom: 4px; }
        .card-lbl    { font-size: 8px; color: #64748b; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; margin-bottom: 3px; }
        .card-val    { font-size: 13px; font-weight: 800; color: #e2e8f0; }
        .card-detail { font-size: 9px; color: #64748b; margin-top: 1px; }

        /* â”€â”€ Alert active â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #alertSection { display: none; flex: 1; flex-direction: column; padding: 0 20px 20px; overflow-y: auto; }
        .alert-head {
            background: linear-gradient(135deg, rgba(220,38,38,0.18), rgba(249,115,22,0.12));
            border: 1.5px solid rgba(220,38,38,0.35);
            padding: 16px; border-radius: 18px; margin-bottom: 10px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .alert-title { font-size: 20px; font-weight: 900; color: #ef4444; margin-bottom: 4px; }
        .alert-veh   { font-size: 12px; color: #fca5a5; }
        .alert-loc   { font-size: 10px; color: #fecaca; margin-top: 4px; }
        .bcast-icon  { font-size: 26px; animation: pulse-anim 1.5s infinite; }
        .bcast-label { font-size: 8px; color: #fca5a5; text-align: center; margin-top: 3px; letter-spacing: 1px; }

        .mic-bar {
            display: flex; align-items: center; gap: 10px;
            background: rgba(220,38,38,0.1); border: 1.5px solid rgba(220,38,38,0.3);
            border-radius: 12px; padding: 10px 14px; margin-bottom: 10px;
        }
        .mic-label { font-size: 12px; font-weight: 700; color: #fca5a5; flex: 1; }
        .mic-timer { font-size: 12px; color: #94a3b8; font-family: monospace; }
        .mic-err   { font-size: 11px; color: #f97316; }
        .waveform  { display: flex; align-items: center; gap: 2px; height: 20px; }
        .wave-bar  { width: 3px; background: #ef4444; border-radius: 2px; animation: wave 0.5s ease-in-out infinite alternate; }
        .wave-bar:nth-child(1){animation-delay:0s;    height:4px;}
        .wave-bar:nth-child(2){animation-delay:0.1s;  height:12px;}
        .wave-bar:nth-child(3){animation-delay:0.2s;  height:20px;}
        .wave-bar:nth-child(4){animation-delay:0.3s;  height:8px;}
        .wave-bar:nth-child(5){animation-delay:0.4s;  height:16px;}
        .wave-bar:nth-child(6){animation-delay:0.05s; height:6px;}
        .wave-bar:nth-child(7){animation-delay:0.25s; height:14px;}
        @keyframes wave { to { height: 3px; opacity: 0.3; } }

        .dispatch-log {
            flex: 1; min-height: 120px;
            background: rgba(0,0,0,0.25); border: 1px solid #1e293b;
            border-radius: 16px; padding: 14px;
            font-family: 'Menlo', 'Monaco', monospace; font-size: 11px;
            overflow-y: auto; -webkit-overflow-scrolling: touch;
            margin-bottom: 12px;
        }
        .log-head  { color: #f97316; font-weight: 700; margin-bottom: 8px; }
        .log-entry { margin-bottom: 8px; border-left: 2px solid rgba(249,115,22,0.3); padding-left: 10px; color: #94a3b8; line-height: 1.5; }

        .alert-actions { display: grid; grid-template-columns: 1fr 1.6fr; gap: 10px; }
        .a-btn {
            padding: 16px; border-radius: 16px; font-weight: 700; cursor: pointer;
            font-size: 14px; display: flex; align-items: center; justify-content: center;
            gap: 6px; color: white; border: none; transition: all 0.15s;
            min-height: 54px;
        }
        .a-btn:active { transform: scale(0.97); }
        .a-btn-share { background: #1a2540; border: 1.5px solid #2d3f5c; color: #94a3b8; }
        .a-btn-safe  { background: linear-gradient(135deg, #16a34a, #15803d); box-shadow: 0 4px 16px rgba(22,163,74,0.3); }

        /* â”€â”€ Status bar (bottom) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .status-bar {
            padding: 10px 20px 14px;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 9px; color: #334155; font-family: monospace; letter-spacing: 0.5px;
            border-top: 1px solid #1a2540;
        }
        .gps-row  { display: flex; align-items: center; gap: 5px; }
        .gps-dot  { width: 6px; height: 6px; border-radius: 50%; }
        .gps-dot.on  { background: #22c55e; animation: pulse-anim 1.5s infinite; }
        .gps-dot.off { background: #334155; }

        /* â”€â”€ Modals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.75);
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            z-index: 100; display: none; flex-direction: column; justify-content: flex-end;
        }
        .modal.show { display: flex; }
        .modal-box {
            background: #111c30; width: 100%;
            border-top: 1.5px solid #2d3f5c;
            padding: 24px 24px max(24px, env(safe-area-inset-bottom));
            max-height: 85dvh; overflow-y: auto; -webkit-overflow-scrolling: touch;
            border-radius: 24px 24px 0 0;
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from{transform:translateY(100%);opacity:0;} to{transform:translateY(0);opacity:1;} }
        .modal-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-title{ font-size: 20px; font-weight: 900; }
        .close-btn  { width: 36px; height: 36px; background: #1a2540; border: none; color: #64748b; cursor: pointer; font-size: 20px; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .close-btn:active { background: #0f172a; color: #fff; }

        .contact-item {
            background: #1a2540; border: 1.5px solid #2d3f5c;
            padding: 14px; border-radius: 14px;
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;
        }
        .contact-name  { font-weight: 700; font-size: 14px; }
        .contact-phone { font-size: 13px; color: #94a3b8; margin-top: 2px; }
        .contact-rel   { font-size: 11px; color: #64748b; margin-top: 2px; }
        .del-btn { width: 40px; height: 40px; background: rgba(220,38,38,0.1); border: none; color: #ef4444; cursor: pointer; font-size: 16px; border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .del-btn:active { background: rgba(220,38,38,0.25); }

        .hist-item { background: #1a2540; border: 1.5px solid #2d3f5c; padding: 14px; border-radius: 14px; margin-bottom: 10px; }
        .hist-row  { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .hist-num  { color: #ef4444; font-weight: 700; font-size: 13px; }
        .hist-time { font-size: 11px; color: #64748b; }
        .hist-detail { font-size: 12px; color: #94a3b8; display: flex; flex-direction: column; gap: 3px; }

        .empty-state { text-align: center; padding: 40px 20px; color: #475569; font-size: 14px; }

        /* â”€â”€ PWA install banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        audio { display: none; }

        /* Scrollbars */
        .form-container::-webkit-scrollbar,
        .dispatch-log::-webkit-scrollbar,
        .modal-box::-webkit-scrollbar,
        #alertSection::-webkit-scrollbar { width: 3px; }
        .form-container::-webkit-scrollbar-thumb,
        .dispatch-log::-webkit-scrollbar-thumb,
        .modal-box::-webkit-scrollbar-thumb,
        #alertSection::-webkit-scrollbar-thumb { background: #2d3f5c; border-radius: 2px; }
    </style>
</head>
<body>
<div class="app">
    <div class="notification" id="notification"></div>

    <!-- â•â• LANDING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="page active" id="landingPage">
        <div class="landing-content">
            <div class="logo-container">ğŸ›¡ï¸</div>
            <h1 class="app-title">ROAD<span style="color:#f97316;"> ANGEL</span></h1>
            <p class="app-subtitle">Elite armed response. Press PANIC â€” dispatchers respond in real time.</p>
            <div class="app-tags">
                <span class="tag">24/7 Response</span>
                <span class="tag">Live GPS</span>
                <span class="tag">Real-time Dispatch</span>
            </div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="app.goTo('signUpPage')">Get Started â†’</button>
                <button class="btn btn-secondary" onclick="app.goTo('loginPage')">Log In</button>
            </div>
            <p style="font-size:10px;color:#475569;">Powered by Firebase â€¢ End-to-end secure</p>
        </div>
    </div>

    <!-- â•â• SIGN UP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="page" id="signUpPage">
        <div class="form-container">
            <div class="form-header" onclick="app.goTo('landingPage')">â† Back</div>
            <h2 class="form-title">Create Account</h2>
            <p class="form-subtitle">Your details are sent to dispatchers when you press PANIC.</p>
            <form class="form" onsubmit="app.handleSignUp(event)">
                <div class="form-row">
                    <div class="input-wrapper">
                        <label class="input-label">First Name</label>
                        <input type="text" placeholder="John" id="signupName" required>
                    </div>
                    <div class="input-wrapper">
                        <label class="input-label">Surname</label>
                        <input type="text" placeholder="Dube" id="signupSurname" required>
                    </div>
                </div>
                <div class="input-wrapper">
                    <label class="input-label">ğŸ“§ Email</label>
                    <input type="email" placeholder="john@example.com" id="signupEmail" required>
                </div>
                <div class="input-wrapper">
                    <label class="input-label">ğŸ“± Phone Number</label>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <span style="color:#f97316;font-weight:bold;font-size:14px;white-space:nowrap;">+27</span>
                        <input type="tel" placeholder="82 123 4567" id="signupPhone"
                               pattern="[0-9 ]{9,12}"
                               title="Enter your SA number without the leading 0 e.g. 82 123 4567"
                               required
                               style="flex:1;"
                               oninput="this.value=this.value.replace(/[^0-9 ]/g,'')">
                    </div>
                    <div style="font-size:9px;color:#64748b;margin-top:4px;">Enter without leading 0 â€” e.g. 82 123 4567</div>
                </div>
                <div class="input-wrapper">
                    <label class="input-label">ğŸ”’ Password</label>
                    <input type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" id="signupPassword" minlength="6" required>
                </div>
                <div class="section-divider">Vehicle Details</div>
                <div class="input-wrapper">
                    <label class="input-label">ğŸš— Number Plate</label>
                    <input type="text" placeholder="GP 123 456" id="signupVehicleReg" required>
                </div>
                <div class="form-row">
                    <div class="input-wrapper">
                        <label class="input-label">Make / Model</label>
                        <input type="text" placeholder="Toyota Hilux" id="signupVehicleMake" required>
                    </div>
                    <div class="input-wrapper">
                        <label class="input-label">ğŸ¨ Color</label>
                        <input type="text" placeholder="White" id="signupVehicleColor" required>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" id="signupBtn" style="margin-top:16px;">Complete Sign Up</button>
            </form>
        </div>
    </div>

    <!-- â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="page" id="loginPage">
        <div class="form-container">
            <div class="form-header" onclick="app.goTo('landingPage')">â† Back</div>
            <h2 class="form-title">Welcome Back</h2>
            <p class="form-subtitle">Log in to access your Road Angel dashboard.</p>
            <form class="form" onsubmit="app.handleLogin(event)" style="margin-top:40px;">
                <div class="input-wrapper">
                    <label class="input-label">ğŸ“§ Email</label>
                    <input type="email" placeholder="your@email.com" id="loginEmail" required>
                </div>
                <div class="input-wrapper">
                    <label class="input-label">ğŸ”’ Password</label>
                    <input type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary" id="loginBtn" style="margin-top:24px;">Log In</button>
                <button type="button" onclick="app.goTo('forgotPage')"
                    style="background:none;border:none;color:#64748b;font-size:12px;cursor:pointer;margin-top:8px;text-decoration:underline;text-underline-offset:3px;">
                    Forgot my password
                </button>
            </form>
        </div>
    </div>

    <!-- â•â• FORGOT PASSWORD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="page" id="forgotPage">
        <div class="form-container">
            <div class="form-header" onclick="app.goTo('loginPage')">â† Back to Login</div>
            <h2 class="form-title">Reset Password</h2>
            <p class="form-subtitle">Enter your email and we'll send you a link to reset your password.</p>
            <form class="form" onsubmit="app.handleForgotPassword(event)" style="margin-top:32px;">
                <div class="input-wrapper">
                    <label class="input-label">ğŸ“§ Email</label>
                    <input type="email" placeholder="your@email.com" id="forgotEmail" required>
                </div>
                <button type="submit" class="btn btn-primary" id="forgotBtn" style="margin-top:16px;">
                    ğŸ“¨ Send Reset Email
                </button>
            </form>
            <div id="forgotSuccess" style="display:none;margin-top:24px;background:rgba(22,163,74,0.1);border:1px solid rgba(22,163,74,0.3);border-radius:12px;padding:16px;text-align:center;">
                <div style="font-size:28px;margin-bottom:8px;">ğŸ“¬</div>
                <div style="font-weight:bold;color:#86efac;margin-bottom:6px;">Reset email sent!</div>
                <div style="font-size:12px;color:#94a3b8;">Check your inbox and follow the link to set a new password. Then come back and log in.</div>
                <button class="btn btn-secondary" onclick="app.goTo('loginPage')" style="margin-top:16px;">â† Back to Login</button>
            </div>
        </div>
    </div>

    <!-- â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="page" id="dashboardPage">
        <!-- Header -->
        <div class="dash-header">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">US</div>
                <div>
                    <div class="user-name" id="userName">User</div>
                    <div class="user-sub"  id="userVehicle">â€”</div>
                </div>
            </div>
            <div class="icon-btns">
                <button class="icon-btn" onclick="app.showContacts()" title="Contacts">ğŸ‘¥</button>
                <button class="icon-btn" onclick="app.showHistory()"  title="History">â°</button>
                <button class="icon-btn logout" onclick="app.logout()" title="Logout">ğŸšª</button>
            </div>
        </div>

        <!-- Status pills -->
        <div class="status-pills">
            <div class="status-pill pill-firebase" id="fbStatus">
                <div class="pill-dot blue" id="fbDot"></div>
                <span id="fbStatusText">Connectingâ€¦</span>
            </div>
            <div class="status-pill pill-gps" id="gpsPill">
                <div class="pill-dot grey" id="gpsPillDot"></div>
                <span id="gpsPillText">GPS: searchingâ€¦</span>
            </div>
        </div>

        <!-- GPS error (shown as pill when GPS fails) -->
        <div class="gps-err-pill" id="gpsErrBanner">
            <span id="gpsErrMsg">GPS error</span>
            <button class="retry-btn" onclick="app.startGps()">Retry</button>
        </div>
        <!-- Hidden old GPS ok banner (logic still references it) -->
        <div class="banner banner-success" id="gpsOkBanner" style="display:none!important;"></div>

        <!-- Panic button -->
        <div class="panic-wrap" id="panicWrap">
            <button class="panic-btn" id="panicBtn" onclick="app.handlePanic()" disabled>
                <div class="panic-icon">âš ï¸</div>
                <div class="panic-label">PANIC</div>
                <div class="panic-sub">TAP TO ALERT DISPATCH</div>
            </button>
            <div class="sys-status" id="sysStatus">ğŸŸ¡ Awaiting GPSâ€¦</div>
        </div>

        <!-- Alert active section -->
        <div id="alertSection">
            <div class="alert-head">
                <div>
                    <div class="alert-title">âš¡ Emergency Active</div>
                    <div class="alert-veh" id="alertVeh">â€”</div>
                    <div class="alert-loc" id="alertLoc">ğŸ“ â€”</div>
                </div>
                <div style="text-align:center;">
                    <div class="bcast-icon">ğŸ“¡</div>
                    <div class="bcast-label">LIVE</div>
                </div>
            </div>

            <!-- Mic recording bar -->
            <div class="mic-bar" id="micBar" style="display:none;">
                <div class="waveform">
                    <div class="wave-bar"></div><div class="wave-bar"></div>
                    <div class="wave-bar"></div><div class="wave-bar"></div>
                    <div class="wave-bar"></div><div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                </div>
                <div class="mic-label">ğŸ™ï¸ Recording &amp; streaming to dispatch</div>
                <div class="mic-timer" id="micTimer">0:00</div>
            </div>
            <div class="mic-bar" id="micErrBar" style="display:none;background:rgba(249,115,22,0.1);border-color:rgba(249,115,22,0.3);">
                <span style="font-size:16px;">ğŸ™ï¸</span>
                <div class="mic-err" id="micErrMsg">Microphone not available</div>
            </div>

            <div class="dispatch-log" id="dispatchLog">
                <div class="log-head">ğŸ“¡ DISPATCH LOG</div>
            </div>
            <div class="alert-actions">
                <button class="a-btn a-btn-share" onclick="app.shareLocation()">ğŸ“ Share</button>
                <button class="a-btn a-btn-safe"  onclick="app.cancelAlert()">I'M SAFE âœ“</button>
            </div>
        </div>

        <!-- Info cards -->
        <div class="info-cards" id="infoCards">
            <div class="info-card">
                <div class="card-icon">ğŸ”‹</div>
                <div class="card-lbl">Battery</div>
                <div class="card-val" id="battVal">--%</div>
            </div>
            <div class="info-card">
                <div class="card-icon">ğŸ“</div>
                <div class="card-lbl">GPS</div>
                <div class="card-val" id="gpsCardVal">â€”</div>
                <div class="card-detail" id="gpsCardDet">accuracy</div>
            </div>
            <div class="info-card">
                <div class="card-icon">ğŸ‘¥</div>
                <div class="card-lbl">Contacts</div>
                <div class="card-val" id="contactsVal">0</div>
            </div>
        </div>
    </div>

    <!-- â•â• CONTACTS MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="modal" id="contactsModal">
        <div class="modal-box">
            <div class="modal-head">
                <h3 class="modal-title">Emergency Contacts</h3>
                <button class="close-btn" onclick="app.hideContacts()">Ã—</button>
            </div>
            <form style="display:flex;flex-direction:column;gap:10px;margin-bottom:20px;" onsubmit="app.addContact(event)">
                <div class="input-wrapper">
                    <label class="input-label">Name</label>
                    <input type="text" placeholder="Mom / Partner" id="cName" required>
                </div>
                <div class="input-wrapper">
                    <label class="input-label">Phone</label>
                    <input type="tel" placeholder="+27 XX XXX XXXX" id="cPhone" required>
                </div>
                <div class="input-wrapper">
                    <label class="input-label">Relationship</label>
                    <input type="text" placeholder="Mother / Partner" id="cRel">
                </div>
                <button type="submit" class="btn btn-primary">ğŸ‘¤ Add Contact</button>
            </form>
            <div id="contactsList"></div>
        </div>
    </div>

    <!-- â•â• HISTORY MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="modal" id="historyModal">
        <div class="modal-box">
            <div class="modal-head">
                <h3 class="modal-title">Alert History</h3>
                <button class="close-btn" onclick="app.hideHistory()">Ã—</button>
            </div>
            <div id="historyList"></div>
        </div>
    </div>

    <!-- Status bar -->
    <div class="status-bar">
        <div class="gps-row">
            <div class="gps-dot off" id="gpsDot"></div>
            <span id="gpsStatusTxt">GPS: STANDBY</span>
        </div>
        <div>ROAD ANGEL SA</div>
        <div>V3.1 FIREBASE</div>
    </div>
</div>

<audio id="alertSnd" src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBT+P1fLIeDEGIXfH8N2RQgsc"></audio>

<script type="module">
import { initializeApp }                          from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, set, update, onValue, get } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";
import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    sendPasswordResetEmail,
    onAuthStateChanged,
    signOut
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

// â”€â”€ Firebase config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const firebaseConfig = {
    apiKey:            "AIzaSyAAHkSygnrYJF4axl2Mc-1wsE7erkI5tSc",
    authDomain:        "punic-button-4428e.firebaseapp.com",
    databaseURL:       "https://punic-button-4428e-default-rtdb.europe-west1.firebasedatabase.app",
    projectId:         "punic-button-4428e",
    storageBucket:     "punic-button-4428e.firebasestorage.app",
    messagingSenderId: "838411218299",
    appId:             "1:838411218299:web:402c4d5c0385946b3ca1de",
    measurementId:     "G-LZY15XKQL5"
};

const firebaseApp = initializeApp(firebaseConfig);
const db          = getDatabase(firebaseApp);
const auth        = getAuth(firebaseApp);

// â”€â”€ App state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const app = window.app = {
    user:          null,   // profile from DB (name, vehicle etc.)
    firebaseUser:  null,   // Firebase Auth user object
    location:      null,
    watchId:       null,
    isAlerting:    false,
    activeAlertId: null,
    alertHistory:  [],
    batteryPct:    '--',
    // â”€â”€ Audio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    mediaRecorder:    null,
    audioStream:      null,
    _warmStream:      null,   // pre-warmed mic stream (silent until PANIC)
    audioChunkIndex:  0,
    micTimerInterval: null,
    micSeconds:       0,
    // â”€â”€ GPS tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    _trackInterval:   null,
    _alertWatcher:    null,

    // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async init() {
        this.loadHistory();
        this.checkBattery();

        // â”€â”€ Capacitor native bootstrap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // window.Capacitor is defined when running inside the native app wrapper.
        // On web it's undefined, so all native calls are safely no-ops.
        if (window.Capacitor?.isNativePlatform()) {
            await this._nativeBootstrap();
        }

        // onAuthStateChanged is the ONLY source of truth for login state.
        onAuthStateChanged(auth, async firebaseUser => {
            if (firebaseUser) {
                this.firebaseUser = firebaseUser;
                const snap = await get(ref(db, 'users/' + firebaseUser.uid));
                if (snap.exists()) {
                    this.user = snap.val();
                    this.monitorConnection();
                    this.goTo('dashboardPage');
                    // Silently warm up mic as soon as user is on dashboard
                    // so permission is already granted before any PANIC is pressed
                    this._warmUpMic();
                } else {
                    await signOut(auth);
                    this.goTo('landingPage');
                }
            } else {
                this.firebaseUser = null;
                this.user         = null;
                this.goTo('landingPage');
            }
        });
    },

    // â”€â”€ Capacitor native setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async _nativeBootstrap() {
        try {
            const { StatusBar, Style } = await import('https://esm.sh/@capacitor/status-bar');
            await StatusBar.setStyle({ style: Style.Dark });
            await StatusBar.setBackgroundColor({ color: '#0f172a' });
        } catch(e) { /* not critical */ }

        try {
            const { KeepAwake } = await import('https://esm.sh/@capacitor-community/keep-awake');
            // Keep screen on while an alert is active â€” released in stopTrackingInterval
            this._keepAwake = KeepAwake;
        } catch(e) { /* not critical */ }

        // Request Location permission upfront (Android needs this before watchPosition)
        try {
            const { Geolocation } = await import('https://esm.sh/@capacitor/geolocation');
            const perm = await Geolocation.requestPermissions();
            if (perm.location !== 'granted') {
                this.notify('âš ï¸ Location permission denied â€” GPS tracking disabled', 'error');
            }
            this._nativeGeo = Geolocation; // store for use in startGps
        } catch(e) { /* fall back to browser geolocation */ }

        // Request Microphone permission upfront
        try {
            const { Microphone } = await import('https://esm.sh/@mozartec/capacitor-microphone');
            const micPerm = await Microphone.requestPermission();
            if (micPerm.microphone !== 'granted') {
                console.warn('Microphone permission not granted');
            }
        } catch(e) { /* fall back to getUserMedia */ }
    },

    monitorConnection() {
        onValue(ref(db, '.info/connected'), snap => {
            const ok  = snap.val();
            const dot  = document.getElementById('fbDot');
            const txt  = document.getElementById('fbStatusText');
            const pill = document.getElementById('fbStatus');
            if (dot)  dot.className   = 'pill-dot ' + (ok ? 'green' : 'red');
            if (txt)  txt.textContent = ok ? 'Connected to Road Angel' : 'Offline';
            if (pill) pill.className  = 'status-pill ' + (ok ? 'pill-firebase' : 'pill-gps error');
        });
    },

    loadHistory() {
        const raw = localStorage.getItem('sl-history');
        if (raw) this.alertHistory = JSON.parse(raw);
    },
    saveHistory() { localStorage.setItem('sl-history', JSON.stringify(this.alertHistory.slice(-20))); },

    // â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    goTo(page) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(page).classList.add('active');
        if (page === 'dashboardPage') { this.updateDashboardUI(); this.startGps(); }
        // Reset forgot password form when navigating away
        if (page !== 'forgotPage') {
            document.getElementById('forgotSuccess').style.display = 'none';
            const fe = document.getElementById('forgotEmail');
            if (fe) fe.value = '';
        }
    },

    // â”€â”€ Notifications â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    notify(msg, type = 'info') {
        const el = document.getElementById('notification');
        el.textContent = msg;
        el.className = `notification show ${type}`;
        setTimeout(() => el.classList.remove('show'), 3500);
    },

    setLoading(btnId, loading, defaultText) {
        const btn = document.getElementById(btnId);
        if (!btn) return;
        btn.disabled     = loading;
        btn.textContent  = loading ? 'â³ Please waitâ€¦' : defaultText;
    },

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  FIREBASE AUTH â€” SIGN UP
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async handleSignUp(e) {
        e.preventDefault();

        const name  = document.getElementById('signupName').value.trim();
        const sur   = document.getElementById('signupSurname').value.trim();
        const email = document.getElementById('signupEmail').value.trim();
        const pass  = document.getElementById('signupPassword').value;
        const reg   = document.getElementById('signupVehicleReg').value.trim();
        const make  = document.getElementById('signupVehicleMake').value.trim();
        const color = document.getElementById('signupVehicleColor').value.trim();

        // Phone validation
        const rawPhone = document.getElementById('signupPhone').value.trim().replace(/\s/g, '');
        if (!rawPhone) { this.notify('âŒ Phone number is required', 'error'); return; }
        const digits = rawPhone.replace(/^0/, '');
        if (digits.length < 9 || digits.length > 10) {
            this.notify('âŒ Enter a valid SA number e.g. 82 123 4567', 'error'); return;
        }
        const phone = '+27' + digits;

        if (!name || !sur || !email || !pass || !reg) {
            this.notify('âŒ Fill all required fields', 'error'); return;
        }

        this.setLoading('signupBtn', true, 'Complete Sign Up');

        try {
            // 1. Create Firebase Auth account (validates email, enforces password rules)
            const cred = await createUserWithEmailAndPassword(auth, email, pass);

            // 2. Save profile to Realtime Database under the user's UID
            const profile = {
                userId:            cred.user.uid,
                name, surname:     sur, email, phone,
                vehicleReg:        reg.toUpperCase(),
                vehicleMake:       make,
                vehicleColor:      color,
                emergencyContacts: [],
                createdAt:         new Date().toISOString()
            };
            await set(ref(db, 'users/' + cred.user.uid), profile);

            // onAuthStateChanged will fire and redirect to dashboard automatically
            this.notify('âœ… Account created! Welcome to Road Angel.', 'success');

        } catch(err) {
            this.setLoading('signupBtn', false, 'Complete Sign Up');
            const msgs = {
                'auth/email-already-in-use':  'âŒ That email is already registered â€” try logging in.',
                'auth/invalid-email':          'âŒ Invalid email address.',
                'auth/weak-password':          'âŒ Password must be at least 6 characters.',
                'auth/network-request-failed': 'âŒ No internet connection.'
            };
            this.notify(msgs[err.code] ?? 'âŒ Sign up failed: ' + err.message, 'error');
        }
    },

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  FIREBASE AUTH â€” LOGIN
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async handleLogin(e) {
        e.preventDefault();

        const email = document.getElementById('loginEmail').value.trim();
        const pass  = document.getElementById('loginPassword').value;

        if (!email || !pass) { this.notify('âŒ Enter your email and password', 'error'); return; }

        this.setLoading('loginBtn', true, 'Log In');

        try {
            // Firebase checks the password â€” wrong password = error, no bypass possible
            await signInWithEmailAndPassword(auth, email, pass);
            // onAuthStateChanged fires â†’ loads profile â†’ redirects to dashboard

        } catch(err) {
            this.setLoading('loginBtn', false, 'Log In');
            const msgs = {
                'auth/invalid-credential':     'âŒ Incorrect email or password.',
                'auth/user-not-found':         'âŒ No account found for that email.',
                'auth/wrong-password':         'âŒ Incorrect password.',
                'auth/invalid-email':          'âŒ Invalid email address.',
                'auth/too-many-requests':      'âš ï¸ Too many attempts â€” try again later or reset your password.',
                'auth/network-request-failed': 'âŒ No internet connection.'
            };
            this.notify(msgs[err.code] ?? 'âŒ Login failed: ' + err.message, 'error');
        }
    },

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  FIREBASE AUTH â€” FORGOT PASSWORD
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async handleForgotPassword(e) {
        e.preventDefault();

        const email = document.getElementById('forgotEmail').value.trim();
        if (!email) { this.notify('âŒ Enter your email address', 'error'); return; }

        this.setLoading('forgotBtn', true, 'ğŸ“¨ Send Reset Email');

        try {
            await sendPasswordResetEmail(auth, email);
            // Show success state â€” don't reveal whether email exists (security best practice)
            document.getElementById('forgotSuccess').style.display = 'block';
            document.querySelector('#forgotPage form').style.display = 'none';

        } catch(err) {
            this.setLoading('forgotBtn', false, 'ğŸ“¨ Send Reset Email');
            const msgs = {
                'auth/invalid-email':          'âŒ Invalid email address.',
                'auth/network-request-failed': 'âŒ No internet connection.',
                'auth/too-many-requests':      'âš ï¸ Too many requests â€” try again in a few minutes.'
            };
            // For user-not-found, still show success (don't leak whether account exists)
            if (err.code === 'auth/user-not-found') {
                document.getElementById('forgotSuccess').style.display = 'block';
                document.querySelector('#forgotPage form').style.display = 'none';
            } else {
                this.notify(msgs[err.code] ?? 'âŒ Error: ' + err.message, 'error');
            }
        }
    },

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  LOGOUT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    async logout() {
        if (this.activeAlertId) await this.cancelAlert();
        else { this.stopAudioRecording(); this.stopTrackingInterval(); this.stopAlertWatcher(); }
        if (this.watchId) navigator.geolocation.clearWatch(this.watchId);
        this.location = null; this.isAlerting = false; this.activeAlertId = null;
        await signOut(auth);
    },

    updateDashboardUI() {
        if (!this.user) return;
        const initials = ((this.user.name?.[0] || 'U') + (this.user.surname?.[0] || '')).toUpperCase();
        document.getElementById('userAvatar').textContent  = initials;
        document.getElementById('userName').textContent    = this.user.name;
        document.getElementById('userVehicle').textContent = `${this.user.vehicleReg} â€¢ ${this.user.vehicleColor} ${this.user.vehicleMake}`;
        document.getElementById('userSub2') && (document.getElementById('userSub2').textContent = this.user.phone ?? '');
        document.getElementById('contactsVal').textContent = (this.user.emergencyContacts || []).length;
    },

    // â”€â”€ GPS â€” continuous tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    startGps() {
        if (!('geolocation' in navigator)) { this.setGpsError('Geolocation not supported'); return; }
        if (this.watchId) navigator.geolocation.clearWatch(this.watchId);

        this.watchId = navigator.geolocation.watchPosition(
            pos => {
                this.location = { lat: pos.coords.latitude, lng: pos.coords.longitude, accuracy: Math.round(pos.coords.accuracy) };
                this.clearGpsError();
                this.updateGpsUI();
                if (this.isAlerting && this.activeAlertId) this._pushLocation();
            },
            err => {
                let msg = 'GPS error â€” enable location services.';
                if (err.code === 1) msg = 'âŒ Permission denied â€” allow location in settings.';
                if (err.code === 2) msg = 'ğŸ“ Position unavailable â€” check GPS signal.';
                if (err.code === 3) msg = 'â±ï¸ GPS timed out â€” retryingâ€¦';
                this.setGpsError(msg);
            },
            { enableHighAccuracy: true, maximumAge: 0, timeout: 30000 }
        );
    },

    // Force-push location to Firebase every 10s during alert (even if user is stationary)
    startTrackingInterval() {
        if (this._trackInterval) clearInterval(this._trackInterval);
        // Keep screen on during emergency (native only)
        if (this._keepAwake) this._keepAwake.keepAwake().catch(() => {});
        this._trackInterval = setInterval(() => {
            if (!this.isAlerting || !this.activeAlertId) {
                clearInterval(this._trackInterval);
                this._trackInterval = null;
                return;
            }
            if (this.location) this._pushLocation();
        }, 10000);
    },

    stopTrackingInterval() {
        if (this._trackInterval) {
            clearInterval(this._trackInterval);
            this._trackInterval = null;
        }
        // Release keep-awake (native only)
        if (this._keepAwake) this._keepAwake.allowSleep().catch(() => {});
    },

    _pushLocation() {
        const now = new Date().toISOString();
        update(ref(db, 'alerts/' + this.activeAlertId), {
            location: this.location,
            battery:  this.batteryPct,
            lastSeen: now
        }).catch(() => {});
        const el = document.getElementById('alertLoc');
        if (el) el.textContent = `ğŸ“ ${this.location.lat.toFixed(5)}, ${this.location.lng.toFixed(5)} Â±${this.location.accuracy}m`;
    },

    // Listen for dispatch resolving the alert remotely
    startAlertWatcher(alertId) {
        if (this._alertWatcher) this._alertWatcher(); // unsubscribe previous
        this._alertWatcher = onValue(ref(db, `alerts/${alertId}/status`), snap => {
            const status = snap.val();
            if (status === 'resolved' && this.isAlerting && this.activeAlertId === alertId) {
                this.notify('âœ… Dispatch has resolved your alert â€” you are safe!', 'success');
                this._doEndAlert();
            }
        });
    },

    stopAlertWatcher() {
        if (this._alertWatcher) {
            this._alertWatcher();
            this._alertWatcher = null;
        }
    },

    setGpsError(msg) {
        document.getElementById('gpsErrMsg').textContent = msg;
        document.getElementById('gpsErrBanner').classList.add('show');
        // New pill
        const dot  = document.getElementById('gpsPillDot');
        const txt  = document.getElementById('gpsPillText');
        const pill = document.getElementById('gpsPill');
        if (dot)  dot.className   = 'pill-dot red';
        if (txt)  txt.textContent = 'GPS: Error';
        if (pill) pill.className  = 'status-pill pill-gps error';
        const sw = document.getElementById('sysStatus');
        if (sw) sw.textContent = 'ğŸŸ¡ Awaiting GPSâ€¦';
        document.getElementById('panicBtn').disabled = true;
        document.getElementById('gpsCardVal').textContent = 'ERROR';
    },

    clearGpsError() {
        document.getElementById('gpsErrBanner').classList.remove('show');
    },

    updateGpsUI() {
        // New pill
        const dot  = document.getElementById('gpsPillDot');
        const txt  = document.getElementById('gpsPillText');
        const pill = document.getElementById('gpsPill');
        if (dot)  dot.className   = 'pill-dot green';
        if (txt)  txt.textContent = this.isAlerting
            ? 'GPS: Tracking ğŸ”´'
            : `GPS Active â€¢ Â±${this.location.accuracy}m`;
        if (pill) pill.className  = 'status-pill pill-gps';
        // Keep status bar dot working
        const gd = document.getElementById('gpsDot');
        if (gd) gd.className = 'gps-dot on';
        const gt = document.getElementById('gpsStatusTxt');
        if (gt) gt.textContent = this.isAlerting ? 'GPS: TRACKING ğŸ”´' : 'GPS: ACTIVE';
        const sw = document.getElementById('sysStatus');
        if (sw && !this.isAlerting) sw.textContent = 'ğŸŸ¢ SYSTEM READY â€” TAP PANIC TO ALERT DISPATCH';
        document.getElementById('panicBtn').disabled = false;
        document.getElementById('gpsCardVal').textContent = this.isAlerting ? 'TRACKING' : 'ACTIVE';
        document.getElementById('gpsCardDet').textContent = 'Â±' + this.location.accuracy + 'm';
    },

    // â”€â”€ Battery â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    checkBattery() {
        if (navigator.getBattery) {
            navigator.getBattery().then(bat => {
                const update = () => {
                    this.batteryPct = Math.round(bat.level * 100);
                    document.getElementById('battVal').textContent = this.batteryPct + '%';
                };
                update();
                bat.onlevelchange = update;
            }).catch(() => {});
        }
    },

    // â”€â”€ PANIC â†’ Firebase + Make.com webhook â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async handlePanic() {
        if (!this.location) { this.notify('â³ Waiting for GPSâ€¦', 'warning'); return; }

        this.isAlerting    = true;
        this.activeAlertId = 'alert-' + Date.now();

        const mapsLink = `https://www.google.com/maps?q=${this.location.lat},${this.location.lng}`;

        const alertData = {
            alertId:      this.activeAlertId,
            status:       'active',
            userId:       this.user.userId,
            userName:     this.user.name,
            userSurname:  this.user.surname,
            userPhone:    this.user.phone ?? '',
            vehicleReg:   this.user.vehicleReg,
            vehicleMake:  this.user.vehicleMake,
            vehicleColor: this.user.vehicleColor,
            location:     this.location,
            battery:      this.batteryPct,
            timestamp:    new Date().toISOString(),
            lastSeen:     new Date().toISOString(),
            resolvedAt:   null,
            resolvedBy:   null
        };

        // â”€â”€ Step 1: Write to Firebase so dispatch sees it â”€
        try {
            await set(ref(db, 'alerts/' + this.activeAlertId), alertData);
        } catch(err) {
            this.notify('âš ï¸ Could not reach server â€” check internet', 'error');
            this.isAlerting = false;
            return;
        }

        // â”€â”€ Step 2: Start continuous GPS tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Force-pushes every 10s even if device is stationary
        // Also watches for dispatch resolving remotely
        this.startTrackingInterval();
        this.startAlertWatcher(this.activeAlertId);
        this.updateGpsUI(); // flip GPS card to "TRACKING"

        // â”€â”€ Step 3: Start audio recording & streaming â”€â”€â”€â”€â”€
        this.startAudioRecording();

        // â”€â”€ Step 2: Fire Make.com webhook DIRECTLY from user app â”€
        // This triggers Retell to call all support services immediately.
        // No dispatcher needs to be online â€” it's fully automatic.
        const MAKE_WEBHOOK = 'https://hook.eu1.make.com/phdt5uufktqhv7w2cxn2auwps964wkvv';

        const webhookPayload = {
            // Alert identity
            alertId:      alertData.alertId,
            timestamp:    alertData.timestamp,
            // Driver
            userName:     this.user.name,
            userSurname:  this.user.surname,
            userPhone:    this.user.phone ?? '',
            userId:       this.user.userId,
            // Vehicle
            vehicleReg:   this.user.vehicleReg,
            vehicleMake:  this.user.vehicleMake,
            vehicleColor: this.user.vehicleColor,
            // Location
            latitude:     this.location.lat,
            longitude:    this.location.lng,
            accuracy:     this.location.accuracy,
            mapsLink,
            battery:      this.batteryPct,
            // â”€â”€ Retell dynamic variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // These map directly to {{variable}} in your Retell agent prompt
            retellVars: {
                driver_name:  `${this.user.name} ${this.user.surname}`,
                driver_phone: this.user.phone ?? '--',
                vehicle_reg:  this.user.vehicleReg,
                vehicle_desc: `${this.user.vehicleColor} ${this.user.vehicleMake}`,
                gps_coords:   `${this.location.lat.toFixed(5)}, ${this.location.lng.toFixed(5)}`,
                maps_link:    mapsLink,
                battery:      String(this.batteryPct ?? '--'),
            }
        };

        // Fire and forget â€” don't block the UI waiting for Make.com
        fetch(MAKE_WEBHOOK, {
            method:  'POST',
            headers: { 'Content-Type': 'application/json' },
            body:    JSON.stringify(webhookPayload)
        })
        .then(res => {
            if (res.ok) {
                this.addLog('ğŸ“ Support services notified via Retell AI');
            } else {
                this.addLog(`âš ï¸ Retell notification failed (HTTP ${res.status}) â€” dispatch alerted`);
            }
        })
        .catch(() => {
            this.addLog('âš ï¸ Could not reach Make.com â€” dispatch alerted via Firebase');
        });

        // UI swap
        document.getElementById('panicWrap').style.display  = 'none';
        document.getElementById('alertSection').style.display = 'flex';
        document.getElementById('infoCards').style.display  = 'none';

        if ('vibrate' in navigator) navigator.vibrate([200,100,200,100,200]);
        document.getElementById('alertSnd').play().catch(() => {});

        document.getElementById('alertVeh').textContent =
            `${alertData.vehicleReg} â€¢ ${alertData.vehicleColor} ${alertData.vehicleMake}`;
        document.getElementById('alertLoc').textContent =
            `ğŸ“ ${this.location.lat.toFixed(5)}, ${this.location.lng.toFixed(5)}`;

        this.addLog('ğŸ“¡ PANIC SIGNAL SENT TO DISPATCH');
        setTimeout(() => this.addLog(`âœ… Verified: ${alertData.userName} ${alertData.userSurname}`), 500);
        setTimeout(() => this.addLog(`ğŸš— ${alertData.vehicleColor} ${alertData.vehicleMake} â€” ${alertData.vehicleReg}`), 1000);
        setTimeout(() => this.addLog(`ğŸ“ GPS: ${this.location.lat.toFixed(5)}, ${this.location.lng.toFixed(5)} (Â±${this.location.accuracy}m)`), 1500);
        setTimeout(() => this.addLog(`âš¡ Dispatchers notified â€” help is on the way`), 2200);

        // Save to local history
        this.alertHistory.push({
            alertId:   this.activeAlertId,
            timestamp: alertData.timestamp,
            location:  this.location,
            vehicle:   `${alertData.vehicleReg} â€” ${alertData.vehicleMake}`
        });
        this.saveHistory();
    },

    addLog(msg) {
        const log   = document.getElementById('dispatchLog');
        const entry = document.createElement('div');
        entry.className   = 'log-entry';
        entry.textContent = msg;
        log.appendChild(entry);
        log.scrollTop = log.scrollHeight;
    },

    // â”€â”€ Cancel alert â†’ update Firebase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async cancelAlert() {
        if (this.activeAlertId) {
            try {
                await update(ref(db, 'alerts/' + this.activeAlertId), {
                    status:     'resolved',
                    resolvedAt: new Date().toISOString(),
                    resolvedBy: 'User (self â€” I\'m safe)'
                });
            } catch(e) { console.warn('Could not update Firebase on cancel:', e); }
        }
        this._doEndAlert();
        this.notify('âœ… Alert cancelled â€” Stay safe!', 'success');
    },

    // Shared cleanup â€” called by both cancelAlert and remote dispatch resolve
    _doEndAlert() {
        this.stopAudioRecording();
        this.stopTrackingInterval();
        this.stopAlertWatcher();
        this.isAlerting    = false;
        this.activeAlertId = null;
        document.getElementById('panicWrap').style.display    = 'flex';
        document.getElementById('alertSection').style.display = 'none';
        document.getElementById('infoCards').style.display    = 'grid';
        document.getElementById('dispatchLog').innerHTML      = '<div class="log-head">ğŸ“¡ DISPATCH LOG</div>';
        this.updateGpsUI(); // flip GPS card back to ACTIVE
    },

    // â”€â”€ Audio recording (MP3 via lamejs) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // â”€â”€ Mic warm-up â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Called silently on login. Requests mic permission and keeps
    // the stream alive so PANIC recording starts with zero delay and zero prompt.
    async _warmUpMic() {
        // Already have a warm stream
        if (this._warmStream) return;
        try {
            this._warmStream = await navigator.mediaDevices.getUserMedia({
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    channelCount:     1,
                    sampleRate:       16000,
                },
                video: false,
            });
            // Mute the track so it's not actually sending audio yet
            this._warmStream.getAudioTracks().forEach(t => { t.enabled = false; });

            // Also pre-load lamejs in the background so first chunk encodes fast
            if (!window.lamejs) {
                const s = document.createElement('script');
                s.src = 'https://cdnjs.cloudflare.com/ajax/libs/lamejs/1.2.1/lame.min.js';
                document.head.appendChild(s);
            }
            console.log('[Road Angel] Mic warmed up â€” permission granted');
        } catch(e) {
            // Permission denied or no mic â€” we'll fall through gracefully on PANIC
            console.warn('[Road Angel] Mic warm-up failed:', e.message);
            this._warmStream = null;
        }
    },

    async startAudioRecording() {
        try {
            // Use the pre-warmed stream if available, otherwise request fresh
            if (this._warmStream) {
                this.audioStream = this._warmStream;
                this._warmStream = null; // take ownership
            } else {
                this.audioStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        channelCount:     1,
                        sampleRate:       16000,
                    },
                    video: false,
                });
            }

            // Un-mute â€” we're recording for real now
            this.audioStream.getAudioTracks().forEach(t => { t.enabled = true; });

            // Ensure lamejs is loaded
            await new Promise((resolve, reject) => {
                if (window.lamejs) { resolve(); return; }
                const s = document.createElement('script');
                s.src = 'https://cdnjs.cloudflare.com/ajax/libs/lamejs/1.2.1/lame.min.js';
                s.onload = resolve;
                s.onerror = reject;
                document.head.appendChild(s);
            });

            const audioCtx    = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
            const source      = audioCtx.createMediaStreamSource(this.audioStream);
            const bufferSize  = 8192;
            const processor   = audioCtx.createScriptProcessor(bufferSize, 1, 1);

            // MP3 encoder â€” 16kHz mono 64kbps (clear speech, small file)
            const mp3enc = new lamejs.Mp3Encoder(1, 16000, 64);
            let   mp3Buf = [];
            let   chunkSamples = 0;
            const samplesPerChunk = 16000 * 5; // 5 seconds of samples

            this.audioChunkIndex = 0;
            this.micSeconds      = 0;

            processor.onaudioprocess = async (e) => {
                if (!this.isAlerting) return;

                // Convert float32 PCM â†’ int16
                const float32 = e.inputBuffer.getChannelData(0);
                const int16   = new Int16Array(float32.length);
                for (let i = 0; i < float32.length; i++) {
                    int16[i] = Math.max(-32768, Math.min(32767, float32[i] * 32768));
                }

                const encoded = mp3enc.encodeBuffer(int16);
                if (encoded.length > 0) mp3Buf.push(...encoded);
                chunkSamples += float32.length;

                // Every 5 seconds, flush a chunk to Firebase
                if (chunkSamples >= samplesPerChunk) {
                    const flushed = mp3enc.flush();
                    if (flushed.length > 0) mp3Buf.push(...flushed);

                    if (mp3Buf.length > 0 && this.activeAlertId) {
                        const bytes  = new Uint8Array(mp3Buf);
                        const base64 = btoa(String.fromCharCode(...bytes));
                        const key    = String(this.audioChunkIndex++).padStart(6, '0');
                        set(ref(db, `alerts/${this.activeAlertId}/audio/${key}`), {
                            data:     base64,
                            mimeType: 'audio/mpeg',
                            ts:       new Date().toISOString()
                        }).catch(() => {});
                    }

                    // Reset for next chunk
                    mp3Buf       = [];
                    chunkSamples = 0;
                }
            };

            source.connect(processor);
            processor.connect(audioCtx.destination);

            // Store refs for cleanup
            this._audioCtx   = audioCtx;
            this._processor  = processor;
            this._mp3enc     = mp3enc;
            this._mp3Buf     = mp3Buf;

            // Show mic bar + start timer
            document.getElementById('micBar').style.display    = 'flex';
            document.getElementById('micErrBar').style.display = 'none';
            this.micTimerInterval = setInterval(() => {
                this.micSeconds++;
                const m  = Math.floor(this.micSeconds / 60);
                const s  = String(this.micSeconds % 60).padStart(2, '0');
                const el = document.getElementById('micTimer');
                if (el) el.textContent = `${m}:${s}`;
            }, 1000);

            this.addLog('ğŸ™ï¸ Mic active â€” streaming MP3 audio to dispatch');

        } catch(err) {
            document.getElementById('micErrBar').style.display = 'flex';
            document.getElementById('micErrMsg').textContent   =
                err.name === 'NotAllowedError'
                    ? 'ğŸ™ï¸ Mic permission denied â€” no audio stream'
                    : 'ğŸ™ï¸ Microphone unavailable â€” no audio stream';
            this.addLog('âš ï¸ Mic unavailable â€” alert sent without audio');
        }
    },

    stopAudioRecording() {
        // Flush final MP3 chunk before stopping
        if (this._mp3enc && this._mp3Buf !== undefined && this.activeAlertId) {
            try {
                const flushed = this._mp3enc.flush();
                if (flushed.length > 0) {
                    const allBytes = [...(this._mp3Buf || []), ...flushed];
                    if (allBytes.length > 0) {
                        const bytes  = new Uint8Array(allBytes);
                        const base64 = btoa(String.fromCharCode(...bytes));
                        const key    = String(this.audioChunkIndex++).padStart(6, '0');
                        set(ref(db, `alerts/${this.activeAlertId}/audio/${key}`), {
                            data:     base64,
                            mimeType: 'audio/mpeg',
                            ts:       new Date().toISOString()
                        }).catch(() => {});
                    }
                }
            } catch(e) { /* ignore flush errors on cleanup */ }
        }

        if (this._processor) { try { this._processor.disconnect(); } catch(e) {} }
        if (this._audioCtx)  { try { this._audioCtx.close();       } catch(e) {} }
        if (this.audioStream) {
            this.audioStream.getTracks().forEach(t => t.stop());
            this.audioStream = null;
        }
        if (this.micTimerInterval) {
            clearInterval(this.micTimerInterval);
            this.micTimerInterval = null;
        }

        this._audioCtx   = null;
        this._processor  = null;
        this._mp3enc     = null;
        this._mp3Buf     = [];
        this.mediaRecorder   = null;
        this.audioChunkIndex = 0;
        this.micSeconds      = 0;

        document.getElementById('micBar').style.display    = 'none';
        document.getElementById('micErrBar').style.display = 'none';

        // Re-warm the mic in the background so the NEXT panic is also instant
        setTimeout(() => this._warmUpMic(), 2000);
    },

    // â”€â”€ Share â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    shareLocation() {
        if (!this.location) { this.notify('âŒ GPS not available', 'error'); return; }
        const u    = this.user;
        const text = `ğŸš¨ Road Angel\nUser: ${u.name} ${u.surname}\nVehicle: ${u.vehicleColor} ${u.vehicleMake} (${u.vehicleReg})\nLocation: https://maps.google.com?q=${this.location.lat},${this.location.lng}\nTime: ${new Date().toLocaleString()}`;
        if (navigator.share) {
            navigator.share({ title: 'Road Angel', text }).catch(() => {});
        } else {
            navigator.clipboard?.writeText(text);
            this.notify('ğŸ“‹ Location copied to clipboard', 'success');
        }
    },

    // â”€â”€ Contacts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    showContacts() { document.getElementById('contactsModal').classList.add('show'); this.renderContacts(); },
    hideContacts() { document.getElementById('contactsModal').classList.remove('show'); },

    renderContacts() {
        const list = document.getElementById('contactsList');
        const arr  = this.user?.emergencyContacts || [];
        list.innerHTML = arr.length === 0
            ? '<div class="empty-state">No contacts yet</div>'
            : arr.map((c, i) => `
                <div class="contact-item">
                    <div>
                        <div class="contact-name">${c.name}</div>
                        <div class="contact-phone">${c.phone}</div>
                        ${c.rel ? `<div class="contact-rel">${c.rel}</div>` : ''}
                    </div>
                    <button class="del-btn" onclick="app.removeContact(${i})">ğŸ—‘ï¸</button>
                </div>`).join('');
    },

    addContact(e) {
        e.preventDefault();
        const name  = document.getElementById('cName').value.trim();
        const phone = document.getElementById('cPhone').value.trim();
        const rel   = document.getElementById('cRel').value.trim();
        if (!name || !phone) { this.notify('âŒ Name and phone required', 'error'); return; }
        if (!this.user.emergencyContacts) this.user.emergencyContacts = [];
        this.user.emergencyContacts.push({ name, phone, rel });
        // Save to Firebase DB so it persists across devices
        update(ref(db, 'users/' + this.firebaseUser.uid), {
            emergencyContacts: this.user.emergencyContacts
        });
        document.getElementById('cName').value = document.getElementById('cPhone').value = document.getElementById('cRel').value = '';
        document.getElementById('contactsVal').textContent = this.user.emergencyContacts.length;
        this.renderContacts();
        this.notify('âœ… Contact added', 'success');
    },

    removeContact(i) {
        this.user.emergencyContacts.splice(i, 1);
        update(ref(db, 'users/' + this.firebaseUser.uid), {
            emergencyContacts: this.user.emergencyContacts
        });
        document.getElementById('contactsVal').textContent = this.user.emergencyContacts.length;
        this.renderContacts();
    },

    // â”€â”€ History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    showHistory() { document.getElementById('historyModal').classList.add('show'); this.renderHistory(); },
    hideHistory() { document.getElementById('historyModal').classList.remove('show'); },

    renderHistory() {
        const list = document.getElementById('historyList');
        if (!this.alertHistory.length) { list.innerHTML = '<div class="empty-state">No alerts yet</div>'; return; }
        list.innerHTML = [...this.alertHistory].reverse().map((a, i) => `
            <div class="hist-item">
                <div class="hist-row">
                    <span class="hist-num">Alert #${this.alertHistory.length - i}</span>
                    <span class="hist-time">${new Date(a.timestamp).toLocaleString()}</span>
                </div>
                <div class="hist-detail">
                    <div>ğŸ“ ${a.location?.lat?.toFixed(4) ?? '--'}, ${a.location?.lng?.toFixed(4) ?? '--'}</div>
                    <div>ğŸš— ${a.vehicle}</div>
                </div>
            </div>`).join('');
    }
};

app.init();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PWA â€” Service Worker + Install Prompt
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Register service worker for offline support
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
            .then(reg => console.log('SW registered:', reg.scope))
            .catch(err => console.warn('SW registration failed:', err));
    });
}

// Intercept the browser's beforeinstallprompt so we can
// show our own styled install banner instead of the default one
let _deferredInstallPrompt = null;

window.addEventListener('beforeinstallprompt', e => {
    e.preventDefault();
    _deferredInstallPrompt = e;

    // Only show banner if not already installed
    if (window.matchMedia('(display-mode: standalone)').matches) return;

    const banner = document.getElementById('installBanner');
    if (banner) banner.style.display = 'flex';
});

// Hide banner once app is installed
window.addEventListener('appinstalled', () => {
    const banner = document.getElementById('installBanner');
    if (banner) banner.style.display = 'none';
    _deferredInstallPrompt = null;
});

window.installApp = async () => {
    if (!_deferredInstallPrompt) return;
    _deferredInstallPrompt.prompt();
    const { outcome } = await _deferredInstallPrompt.userChoice;
    if (outcome === 'accepted') {
        const banner = document.getElementById('installBanner');
        if (banner) banner.style.display = 'none';
    }
    _deferredInstallPrompt = null;
};

window.dismissInstall = () => {
    const banner = document.getElementById('installBanner');
    if (banner) banner.style.display = 'none';
};
</script>

<!-- PWA Install Banner -->
<div id="installBanner" style="
    display:none; position:fixed; bottom:0; left:0; right:0; z-index:9999;
    background:linear-gradient(135deg,#1e293b,#0f172a);
    border-top:1px solid rgba(251,191,36,0.3);
    padding:14px 18px calc(14px + env(safe-area-inset-bottom));
    flex-direction:column; gap:10px;
    box-shadow: 0 -8px 32px rgba(0,0,0,0.5);">
    <div style="display:flex;align-items:center;gap:12px;">
        <div style="font-size:32px;flex-shrink:0;">ğŸ›¡ï¸</div>
        <div style="flex:1;">
            <div style="font-size:13px;font-weight:900;color:#f1f5f9;">Install Road Angel</div>
            <div style="font-size:11px;color:#94a3b8;margin-top:2px;">Add to your home screen for instant one-tap access in an emergency</div>
        </div>
        <button onclick="dismissInstall()" style="background:none;border:none;color:#64748b;font-size:20px;cursor:pointer;padding:4px;">âœ•</button>
    </div>
    <div style="display:flex;gap:8px;">
        <button onclick="dismissInstall()" style="flex:1;padding:10px;background:rgba(255,255,255,0.05);border:1px solid #334155;color:#94a3b8;border-radius:10px;cursor:pointer;font-size:12px;font-weight:bold;">Not now</button>
        <button onclick="installApp()" style="flex:2;padding:10px;background:linear-gradient(135deg,#f59e0b,#d97706);border:none;color:#000;border-radius:10px;cursor:pointer;font-size:12px;font-weight:900;">âš¡ Install App</button>
    </div>
</div>

</body>
</html>
